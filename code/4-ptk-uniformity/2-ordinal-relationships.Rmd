---
title: "2. /ptk/ uniformity - ordinal relationships"
author: "Khia A Johnson"
date: "4/1/2021"
output: html_document
---

## setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggthemes)

theme_set(
  theme_clean() + 
  theme(
      legend.title = element_blank(),
      legend.text = element_text(size=8),
      legend.position = 'bottom',
      axis.title.x = element_text(size = 8, face='bold'),
      axis.title.y = element_text(size = 8, face='bold'),
      axis.text.x = element_text(size = 8),
      axis.text.y = element_text(size = 8),
      strip.text = element_text(size = 8, face='bold'),
      )
  )
```

```{r}
df <- read_csv('ptk_clean_20210331.csv') # this version used for interspeech
head(df)
```


## Oridnal relationship proportions
Proportion of talkers adhering to expected ptk duration relationships (more posterior --> longer) given prior work on connected (but not spontaneous) speech. These numbers are all over the map, though if we take the estimates for /p/ with a grain of salt (some individuals have very few tokens), the t-k comparison more or less follows expectations.
```{r}
df %>%
  group_by(talker, segment, language) %>%
  summarise(mv = mean(vot_ms)) %>%
  ungroup() %>%
  pivot_wider(names_from = 'segment', values_from = 'mv') %>%
  ungroup() %>%
  drop_na() %>%
  group_by(language) %>%
  summarise(
    pt = sum(p<t)/n(), 
    tk = sum(t<k)/n(), 
    pk = sum(p<k)/n(),
    n=n()
    )
```

But... looking at just the talkers who produce more /p/ tokens doesn't really change those proportions in ways that better reflect expected ordinal relationships. Takeaway? These might be differences between spontaneous and read speech. 
```{r}
df %>%
  group_by(talker, segment, language) %>%
  summarise(mv = mean(vot_ms), n=n()) %>%
  filter(n>=10) %>%
  select(talker, segment, language, mv) %>%
  ungroup() %>%
  pivot_wider(names_from = 'segment', values_from = 'mv') %>%
  ungroup() %>%
  drop_na() %>%
  group_by(language) %>%
  summarise(
    pt = sum(p<t)/n(), 
    tk = sum(t<k)/n(), 
    pk = sum(p<k)/n(),
    n=n()
    )
```

Range of counts that the means are based on -- far fewer per talker for /p/
```{r}
df %>%
  group_by(talker, segment, language) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  group_by(language, segment) %>%
  summarise(min(n), mean(n), max(n))
```

## Visualizing ordinal relationships
Ordinal relationships within talker by language, in graphical form -- probably wont include this in the paper
```{r fig.width=12, fig.height=3}
df %>%
  group_by(talker, language, segment) %>%
  summarise(mean_vot = mean(vot_ms), sd_vot = sd(vot_ms), n=n()) %>%
  ungroup() %>%
  mutate(segment = str_to_upper(segment)) %>%
  ggplot(aes(y=mean_vot, x=talker, color=language, label=segment)) +
    geom_text(fontface='bold', size=5, position=position_dodge(width = 0.75)) +
    geom_line(alpha=0.5, position=position_dodge(width = 0.75)) +
    # scale_color_viridis_d(option = 'inferno', begin = 0.1, end = 0.8) +
    scale_color_manual(values = c('darkolivegreen','skyblue')) +
  ylab('Mean VOT (ms)') +
  xlab('Talker') +
  scale_y_continuous(limits = c(15, 85))+
    theme(
      axis.text = element_text(angle=90),
      panel.grid.major.x = element_line(color = 'gray', linetype='dotted'),
      legend.position = 'right'
    )

ggsave('ordrel.png', height=3.5, width = 12, units='in') # This used in ISBPAC poster
```

## Visualizing within talker segment relationships
```{r fig.width=7, fig.height=3.5}
std.error <- function(x, na.rm = T) {
  sqrt(var(x, na.rm = na.rm)/length(x[complete.cases(x)]))
}

df$segment <- as_factor(df$segment)
df$segment <- forcats::fct_relevel(df$segment, 'p','t','k')
levels(df$segment)
```

```{r fig.height=8, fig.width=3.5}
df %>%
  group_by(talker, language, segment) %>%
  summarise(mean_vot = mean(vot_ms), se_vot = std.error(vot_ms), n=n()) %>%
  ungroup() %>%
  mutate(language = if_else(language=='Cantonese', 'C','E')) %>%
  ggplot(aes(y=language, x=mean_vot, shape=segment, color=segment)) +
    geom_point(shape=5) +
    geom_errorbar(position = "identity", size=.5,width = .25, aes(xmin = mean_vot-se_vot, xmax = mean_vot+se_vot)) +
    geom_line(aes(group=segment), size=.75) +
    scale_color_viridis_d(option = 'inferno', begin = 0.1, end = 0.8) +
    facet_wrap(~talker, ncol=3)+
    labs(y="",  x="VOT (ms)") +
    theme(
      strip.text = element_text(size=6),
      legend.position = 'bottom'
    )

# ggsave('ptk_vot_individuals_vert.png', height = 8.5, width = 3.5, units='in') # Used in interspeech paper with manually moved legend - don't re-run; different sizes for paper and poster
```

