---
title: "2. /ptk/ uniformity - ordinal relationships"
author: "Khia A Johnson"
date: "4/1/2021"
output: html_document
---

## Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggthemes)
library(gridExtra)
library(psych)
library(kableExtra)

theme_set(
  theme_clean() + 
  theme(
      legend.title = element_blank(),
      legend.text = element_text(size=8),
      legend.position = 'bottom',
      axis.title.x = element_text(size = 8, face='bold'),
      axis.title.y = element_text(size = 8, face='bold'),
      axis.text.x = element_text(size = 8),
      axis.text.y = element_text(size = 8),
      strip.text = element_text(size = 8, face='bold'),
      )
  )
```

```{r}
df <- read_csv('dfs/ptk_clean_20210602.csv') # this version used in Interspeech paper
head(df)
```

```{r}
means <- df %>%
  group_by(talker, language, segment) %>%
  summarise(mean_vot_ms = mean(vot_ms)) %>%
  ungroup() %>%
  pivot_wider(names_from = 'segment', values_from = 'mean_vot_ms') 
```

## Raw VOT 
### Correlations: Mean VOT

Prep wide format data frame
```{r}
dfsummary <- df %>%
  group_by(talker, language, segment) %>%
  summarise(mvot = mean(vot_ms)) %>%
  ungroup() %>%
  pivot_wider(names_from = c('language','segment'), values_from = 'mvot') %>%
  select(CanP=Cantonese_p, CanT=Cantonese_t, CanK=Cantonese_k, EngP=English_p, EngT=English_t, EngK=English_k)
 
dfsummary
```

Run correlations with adjusted p-values
```{r}
output <- corr.test(dfsummary, method='pearson', adjust = 'holm')
output
```


### Data Viz: Mean VOT

Set up within-language plots
```{r fig.width=9, fig.height=3}
pt <- ggplot(means, aes(x=p, y=t, color=language, fill=language)) +
        geom_point() +
        geom_smooth(method='lm', formula = 'y ~ x') +
        scale_color_viridis_d(option = 'inferno', begin = 0.1, end = 0.8) +
        scale_fill_viridis_d(option = 'inferno', begin = 0.1, end = 0.8) +
        scale_x_continuous(limits = c(10,90)) + 
        scale_y_continuous(limits = c(10,90)) 

pk <- ggplot(means, aes(x=p, y=k, color=language, fill=language)) +
        geom_point() +
        geom_smooth(method='lm', formula = 'y ~ x') +
        scale_color_viridis_d(option = 'inferno', begin = 0.1, end = 0.8) +
        scale_fill_viridis_d(option = 'inferno', begin = 0.1, end = 0.8)+
        scale_x_continuous(limits = c(10,90)) + 
        scale_y_continuous(limits = c(10,90)) 

tk <- ggplot(means, aes(x=t, y=k, color=language, fill=language)) +
        geom_point() +
        geom_smooth(method='lm', formula = 'y ~ x') +
        scale_color_viridis_d(option = 'inferno', begin = 0.1, end = 0.8) +
        scale_fill_viridis_d(option = 'inferno', begin = 0.1, end = 0.8)+
        scale_x_continuous(limits = c(10,90)) + 
        scale_y_continuous(limits = c(10,90)) 
```

Set up across-language uniformity plots
```{r}
pp <- means %>%
  select(talker, language, p) %>%
  pivot_wider(names_from = 'language', values_from = 'p') %>%
  ggplot(aes(x=Cantonese, y=English)) +
      geom_point() +
      geom_smooth(method='lm', formula = 'y ~ x', color='black') +
      scale_x_continuous(limits = c(10,90)) + 
      scale_y_continuous(limits = c(10,90)) 
pp <- pp + ggtitle('/p/')

tt <- means %>%
  select(talker, language, t) %>%
  pivot_wider(names_from = 'language', values_from = 't') %>%
  ggplot(aes(x=Cantonese, y=English)) +
      geom_point() +
      geom_smooth(method='lm', formula = 'y ~ x', color='black') +
      scale_x_continuous(limits = c(10,90)) + 
      scale_y_continuous(limits = c(10,90)) 
tt <- tt + ggtitle('/t/')

kk <- means %>%
  select(talker, language, k) %>%
  pivot_wider(names_from = 'language', values_from = 'k') %>%
  ggplot(aes(x=Cantonese, y=English)) +
      geom_point() +
      geom_smooth(method='lm', formula = 'y ~ x', color='black') +
      scale_x_continuous(limits = c(10,90)) + 
      scale_y_continuous(limits = c(10,90)) 

kk <- kk + ggtitle('/k/')
```

Show the plots; legends are annoying but oh well
```{r fig.width=9, fig.height=6}
grid.arrange(pt, pk, tk, pp, tt, kk, nrow=2)
```

### Data Viz: Mean vs. SDs
Mean vs. SD correlations -- same structured relationship across languages and categories; This part isn't particularly interesting to current purposes, and isn't included in Interspeech paper
```{r fig.width=8, fig.height=3}
 df %>%
  group_by(talker, language, segment) %>%
  summarise(mvot = mean(vot_ms), sdvot = sd(vot_ms)) %>%
  ungroup() %>%
  ggplot(aes(x=sdvot, y=mvot, color=language, fill=language)) +
    geom_point() + 
    geom_smooth(method='lm', formula = 'y ~ x') +
    scale_color_colorblind()+
  scale_fill_colorblind()+
    facet_wrap(~segment)
```


## Residual VOT (accounting for rate)

Compute residual VOT via simple VOT ~ rate regression, and add to data frame
```{r}
rdf <- df
resmodel <- lm(vot_ms ~ avg_phone_dur_ms, data = rdf)
rdf$residual_vot_ms <- resid(resmodel)
```

Prep wide summary data frame and run correlation
```{r}
rdfsummary <- rdf %>%
  group_by(talker, language, segment) %>%
  summarise(mvot = mean(residual_vot_ms)) %>%
  ungroup() %>%
  pivot_wider(names_from = c('language','segment'), values_from = 'mvot') %>%
  select(
    `Cantonese P`=Cantonese_p, 
    `Cantonese T`=Cantonese_t, 
    `Cantonese K`=Cantonese_k, 
    `English P`=English_p, 
    `English T`=English_t, 
    `English K`=English_k)
 
rdfout <- corr.test(rdfsummary, method='pearson', adjust = 'holm')
```

```{r}
options(scipen = 999)

rdfout$ci %>%
  rownames_to_column(var = 'comparison') %>%
  left_join(rdfout$ci2, by=c('r','p')) %>%
  select(comparison, r, p.adj) %>%
  separate(comparison, into = c('a', 'b'), sep='-') %>%
  mutate(r = round(r, 2), p.adj = round(p.adj, 4))
    
```

```{r}
ggcorr(data=NULL, cor_matrix=rdfout$r, label=TRUE, nbreaks = 10, label_round = 2, low = "white", mid='white', high='#e6550d')
```


```{r fig.width=6}
cor.plot(rdfout$r, show.legend = FALSE, stars =FALSE, diag=TRUE, upper=FALSE)
```


## Visualize (residual) VOT relationships

Wrangle data frame for plotting
```{r}
resid_means <- rdf %>%
  group_by(talker, language, segment) %>%
  summarise(mean_resid_vot = mean(residual_vot_ms)) %>%
  ungroup() %>%
  pivot_wider(names_from = 'segment', values_from = 'mean_resid_vot') 

wide_means <- resid_means %>%
  pivot_wider(id_cols = talker, names_from = language, values_from = c('p','t','k')) %>%
  select(`Cantonese /p/` = p_Cantonese, `Cantonese /t/` = t_Cantonese, `Cantonese /k/` = k_Cantonese, 
         `English /p/` = p_English, `English /t/` = t_English, `English /k/` = k_English)
```

Build each panel individually with selected pairwise correlations: within-language English and Cantonese, and cross-language homorganic comparisons

**NOTE** that the 3x3 set of figures here has annotations with the r and p values from before I removed words without initial stress from the sample, and will need to be updated for dissertation
```{r fig.width=9, fig.height=3}
app <- ggplot(wide_means, aes(x=`Cantonese /p/`, y=`English /p/`)) + 
  geom_point(color='orange') +
  geom_smooth(method='lm', formula = 'y ~ x', color='orange', fill='orange') +
  scale_x_continuous(limits = c(-27,27)) + 
  scale_y_continuous(limits = c(-27,27)) 
app <- app + 
  annotate("text", x = 18, y = -20, label = 'r = 0.57\np = 0.006*') + 
  ggtitle('Cantonese /p/ ~ English /p/')

att <- ggplot(wide_means, aes(x=`Cantonese /t/`, y=`English /t/`)) + 
  geom_point(color='orange') +
  geom_smooth(method='lm', formula = 'y ~ x', color='orange', fill='orange')+
  scale_x_continuous(limits = c(-27,27)) + 
  scale_y_continuous(limits = c(-27,27)) 

att <- att + 
  annotate("text", x = 18, y = -20, label = 'r = 0.31\np = 0.29') + 
  ggtitle('Cantonese /t/ ~ English /t/')

akk <- ggplot(wide_means, aes(x=`Cantonese /k/`, y=`English /k/`)) + 
  geom_point(color='orange') +
  geom_smooth(method='lm', formula = 'y ~ x', color='orange', fill='orange')+
  scale_x_continuous(limits = c(-27,27)) + 
  scale_y_continuous(limits = c(-27,27)) 

akk <- akk + 
  annotate("text", x = 18, y = -20, label = 'r = 0.55\np = 0.006*') + 
  ggtitle('Cantonese /k/ ~ English /k/')

ept <- ggplot(wide_means, aes(x=`English /p/`, y=`English /t/`)) + 
  geom_point(color='skyblue') +
  geom_smooth(method='lm', formula = 'y ~ x', color='skyblue', fill='skyblue')+
  scale_x_continuous(limits = c(-27,27)) + 
  scale_y_continuous(limits = c(-27,27)) 
ept <- ept + 
  annotate("text", x = 18, y = -20, label = 'r = 0.58\np = 0.004*') + 
  ggtitle('English /p/ ~ English /t/')

epk <- ggplot(wide_means, aes(x=`English /p/`, y=`English /k/`)) + 
  geom_point(color='skyblue') +
  geom_smooth(method='lm', formula = 'y ~ x', color='skyblue', fill='skyblue') +
  scale_x_continuous(limits = c(-27,27)) + 
  scale_y_continuous(limits = c(-27,27)) 
epk <- epk + 
  annotate("text", x = 18, y = -20, label = 'r = 0.75\np <0.001*') + 
  ggtitle('English /p/ ~ English /k/')

etk <- ggplot(wide_means, aes(x=`English /t/`, y=`English /k/`)) + 
  geom_point(color='skyblue') +
  geom_smooth(method='lm', formula = 'y ~ x', color='skyblue', fill='skyblue') +
  scale_x_continuous(limits = c(-27,27)) + 
  scale_y_continuous(limits = c(-27,27)) 
etk <- etk + 
  annotate("text", x = 18, y = -20, label = 'r = 0.57\np = 0.005*') + 
  ggtitle('English /t/ ~ English /k/')

cpt <- ggplot(wide_means, aes(x=`Cantonese /p/`, y=`Cantonese /t/`)) + 
  geom_point(color='darkolivegreen') +
  geom_smooth(method='lm', formula = 'y ~ x', color='darkolivegreen', fill='darkolivegreen') +
  scale_x_continuous(limits = c(-27,27)) + 
  scale_y_continuous(limits = c(-27,27)) 
cpt <- cpt + 
  annotate("text", x = 18, y = -20, label = 'r = 0.59\np = 0.004*') + 
  ggtitle('Cantonese /p/ ~ Cantonese /t/')

cpk <- ggplot(wide_means, aes(x=`Cantonese /p/`, y=`Cantonese /k/`)) + 
  geom_point(color='darkolivegreen') +
  geom_smooth(method='lm', formula = 'y ~ x', color='darkolivegreen', fill='darkolivegreen') +
  scale_x_continuous(limits = c(-27,27)) + 
  scale_y_continuous(limits = c(-27,27)) 
cpk <- cpk + 
  annotate("text", x = 18, y = -20, label = 'r = 0.54\np = 0.009') + 
  ggtitle('Cantonese /p/ ~ Cantonese /k/')

ctk <- ggplot(wide_means, aes(x=`Cantonese /t/`, y=`Cantonese /k/`)) + 
  geom_point(color='darkolivegreen') +
  geom_smooth(method='lm', formula = 'y ~ x', color='darkolivegreen', fill='darkolivegreen') +
  scale_x_continuous(limits = c(-27,27)) +
  scale_y_continuous(limits = c(-27,27))
ctk <- ctk + 
  annotate("text", x = 18, y = -20, label = 'r = 0.33\np = 0.28') + 
  ggtitle('Cantonese /t/ ~ Cantonese /k/')
```

Arrange plots in a single big poster figure
```{r fig.width=12, fig.height=10}
all <- grid.arrange(cpt, cpk, ctk, ept, epk, etk, app, att, akk, nrow=3)
# ggsave('figs/correlation_uniformity.png', plot=all, height = 10, width = 12, units='in') #used in ISBPAC poster
```
