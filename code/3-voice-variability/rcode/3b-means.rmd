---
title: 'Chapter 3: Compare means'
author: "Khia A. Johnson"
date: "7/23/2021"
output: html_document
---

```{r}
library(data.table)
library(tidyverse)
library(ggthemes)
library(lsr)
library(broom)
```

visualization defaults
```{r}
theme_set(theme_clean() + theme(
      legend.title = element_blank(),
      legend.text = element_text(size=6),
      legend.position = 'bottom',
      axis.title.x = element_text(size = 10, face='bold'),
      axis.title.y = element_text(size = 10, face='bold'),
      strip.text = element_text(size=10, face='bold'),
      plot.background = element_blank()
    ))
```


```{r}
df <- fread('../data/spice_voicesauce_processed.csv', sep = ',') 
```

Pivot longer to prep for getting t-test and cohen's d results
```{r}
long_df <- df %>%
  select(Talker, Language, F0:SHR_sd) %>%
  pivot_longer(F0:SHR_sd, names_to = 'Variable', values_to = 'Value')
```

## Visualize

```{r fig.width=5, fig.height=6.5}
long_df %>%
    filter(str_detect(Variable, 'sd', negate=TRUE)) %>%
  select(Talker, Language, Variable, Value) %>%
  ggplot(aes(x=Value, color=Language)) +
    geom_density() +
    scale_color_viridis_d(option='magma', begin = 0.75, end = 0)+
    facet_wrap(~Variable, scales = 'free', ncol = 3) +
    ylab('Density') +
    xlab('')

ggsave('../../../text/figures/ch3_allmeasuresdensity_5in.png', width = 5, height = 6.5)

```

ggsave('../../text/figures/ch2_cantonesetypecounts_5in.png', width = 5, height = 6.5)

## Bayesian estimation
```{r}
library(brms)
library(tidybayes)
```

```{r}
df_cpp <- df %>%
  select(Talker, Language, CPP) %>%
  mutate(CPP_z = scale(CPP),
         Language = as_factor(Language))

vf19a_cpp <- df_cpp %>%
  filter(Talker=='VF19A')
```

Setup according to https://mvuorre.github.io/posts/2017-01-02-how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms/
```{r}
best_cpp <- brm(
  bf(CPP ~ Language, sigma ~ Language),
  family = student,
  data = vf19a_cpp,
  cores = 4,
  file = "best_vf19a_cpp"
)
```

```{r}
best_cpp
```




For each measure, use:

- Formula: Measure ~ Language + (Language | Talker)

```{r fig.width=5, fig.height=6.5}
df %>%
  select(Talker, Language, i, CPP) %>%
  ggplot(aes(x=CPP, color=Language)) +
    geom_density() +
    scale_color_viridis_d(option='magma', begin = 0.75, end = 0)+
    facet_wrap(~Talker, ncol = 5) +
    ylab('Density') +
    xlab('CPP (dB)') +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

```{r fig.width=5, fig.height=6.5}
df %>%
  select(Talker, Language, i, F0) %>%
  ggplot(aes(x=F0, color=Language)) +
    geom_density() +
    scale_color_viridis_d(option='magma', begin = 0.75, end = 0)+
    facet_wrap(~Talker, ncol = 5) +
    ylab('Density') +
    xlab('F0 (Hz)') +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```


Do all the t-tests and cohen's d calculations
```{r}
# ttest_results <- long_df %>%
#   group_by(Talker, Variable) %>%
#   summarise(
#     cohen_d = cohensD(Value ~ Language, method='pooled'),
#     t_test = list(t.test(Value ~ Language,  var.equal = TRUE, conf.level = 0.95))
#     ) %>%
#   mutate(tidied=map(t_test,tidy)) %>%
#   unnest(tidied) %>%
#   select(Talker:cohen_d, estimate1:conf.high)

# fwrite(ttest_results,'../data/spice_voicesauce_ttests.csv')
ttest_results <- fread('../data/spice_voicesauce_ttests.csv')

```


Display the non-trivial comparisons
```{r fig.width=6, fig.height=12}
ttest_results %>%
  mutate(Difference = estimate1-estimate2,
         Significant = p.value < 0.01,
         CohenD = if_else(cohen_d<0.2, 'Trivial', 
                          if_else(cohen_d<0.5, 'Small', 
                                  if_else(cohen_d<0.8, 'Medium', 'Large')))
         ) %>%
  
  select(Talker, Variable, Difference, Significant, CohenD) %>%
  group_by(Talker, Variable, CohenD) %>%
  summarise(mean(Difference), n()) %>%
  filter(CohenD!='Trivial')
```

