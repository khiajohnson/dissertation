---
title: 'Chapter 3: Compare means'
author: "Khia A. Johnson"
date: "7/23/2021"
output: html_document
---

```{r}
library(data.table)
library(tidyverse)
library(ggthemes)
library(lsr)
library(broom)
library(brms)
library(tidybayes)

sessionInfo()
```

visualization defaults
```{r}
theme_set(theme_clean() + theme(
      legend.title = element_blank(),
      legend.text = element_text(size=6),
      legend.position = 'bottom',
      axis.title.x = element_text(size = 10, face='bold'),
      axis.title.y = element_text(size = 10, face='bold'),
      strip.text = element_text(size=10, face='bold'),
      plot.background = element_blank()
    ))
```


```{r}
df <- fread('../data/spice_voicesauce_processed.csv', sep = ',') 
```

## Visualize

Pivot longer to prep for getting t-test and cohen's d results // data viz
```{r}
long_df <- df %>%
  select(Talker, Language, F0:SHR_sd) %>%
  pivot_longer(F0:SHR_sd, names_to = 'Variable', values_to = 'Value')
```

```{r fig.width=5, fig.height=6.5}
long_df %>%
    filter(str_detect(Variable, 'sd', negate=TRUE)) %>%
  select(Talker, Language, Variable, Value) %>%
  ggplot(aes(x=Value, color=Language)) +
    geom_density() +
    scale_color_viridis_d(option='magma', begin = 0.75, end = 0)+
    facet_wrap(~Variable, scales = 'free', ncol = 3) +
    ylab('Density') +
    xlab('')

#ggsave('../../../text/figures/ch3_allmeasuresdensity_5in.png', width = 5, height = 6.5)

```


## Bayesian estimation

Do one model for each acoustic measurement, using robust t-distribution for all measures except 
- SHR, which gets a zero-inflated beta
- Energy could get a log-normal

General formula:
- Measure ~ 0 + Language + (0 + Language | Talker)

For each measure, use:

- Formula: Measure ~ Language + (Language | Talker)

```{r}
cpp <- df %>%
  group_by(Talker, Language) %>%
  slice_sample(n=500) %>%
  ungroup() %>%
  select(Talker, Language, CPP) %>%
  mutate(CPP_z = scale(CPP))

```

```{r fig.width=5, fig.height=6.5}
cpp %>%
  ggplot(aes(x=CPP_z, color=Language)) +
    geom_density() +
    scale_color_viridis_d(option='magma', begin = 0.75, end = 0)+
    facet_wrap(~Talker, ncol = 5) +
    ylab('Density') +
    xlab('CPP (dB)') +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

```{r}
get_prior(
  data = cpp, 
  family = gaussian,
  formula = CPP_z ~ 0 + Language + (0 + Language | Talker)
)
```


Using recommended regularizing prior from Gelman & stan crew
```{r}
cpp.fit.1 <- brm(data = cpp, 
             family = student(),
             formula = CPP_z ~ 0 + Language + (0 + Language | Talker),
             prior = c(prior(normal(0, 1), class = b),
                       prior(lkj(2), class = cor)),
             sample_prior = TRUE,
             iter = 2000, warmup = 1000, chains = 6, cores = 6, 
             file = "fits/cpp.fit.1")
```

started at 12:15
chains starting to finish at 12:40

```{r}
summary(cpp.fit.1)
```


```{r}
mcmc_plot(cpp.fit.1, type = 'trace')
mcmc_plot(cpp.fit.1, type = 'neff_hist')
mcmc_plot(cpp.fit.1, type = 'nuts_divergence')
mcmc_plot(cpp.fit.1, type = 'rhat_hist')
```

Plotting comparisons between languages with ROPE of [-0.1, 0.1]
```{r fig.width=10, fig.height=5}
cpp.fit.1 %>%
  spread_draws(r_Talker[Talker,Language]) %>%
  mutate(Language = str_replace(Language, 'Language', '')) %>%
  group_by(Talker) %>%
  compare_levels(r_Talker, by=Language) %>%
  ungroup() %>%
  mutate(Talker = reorder(Talker, r_Talker)) %>%
  ggplot(aes(x=Talker, y=r_Talker)) + 
  stat_pointinterval() + 
  annotate(geom = "rect", ymin = -0.1, ymax = 0.1, xmin = -Inf, xmax = Inf,
           fill = "skyblue", colour = "black", alpha = 0.5) +
  theme(axis.text.x = element_text(angle=90)) +
  xlab('') +
  ylab('CPP Posterior difference for Cantonese-English')

ggsave('../../../text/figures/ch3_cpp_5in.png', width = 5, height = 2.5)

```



Do all the t-tests and cohen's d calculations
```{r}
# ttest_results <- long_df %>%
#   group_by(Talker, Variable) %>%
#   summarise(
#     cohen_d = cohensD(Value ~ Language, method='pooled'),
#     t_test = list(t.test(Value ~ Language,  var.equal = TRUE, conf.level = 0.95))
#     ) %>%
#   mutate(tidied=map(t_test,tidy)) %>%
#   unnest(tidied) %>%
#   select(Talker:cohen_d, estimate1:conf.high)

# fwrite(ttest_results,'../data/spice_voicesauce_ttests.csv')
ttest_results <- fread('../data/spice_voicesauce_ttests.csv')

```


Display the non-trivial comparisons
```{r fig.width=6, fig.height=12}
ttest_results %>%
  mutate(Difference = estimate1-estimate2,
         Significant = p.value < 0.01,
         CohenD = if_else(cohen_d<0.2, 'Trivial', 
                          if_else(cohen_d<0.5, 'Small', 
                                  if_else(cohen_d<0.8, 'Medium', 'Large')))
         ) %>%
  
  select(Talker, Variable, Difference, Significant, CohenD) %>%
  group_by(Talker, Variable, CohenD) %>%
  summarise(mean(Difference), n()) %>%
  filter(CohenD!='Trivial')
```

